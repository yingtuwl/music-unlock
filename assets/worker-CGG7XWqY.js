class ue extends Error{code="UNKNOWN";toJSON(){const{name:e,message:t,stack:r,code:i}=this;return{name:e,message:t,stack:r,code:i}}}class y extends ue{code="UNSUPPORTED_FILE"}class Ne{handlers=new Map;addEventHandler(e,t){this.handlers.set(e,t)}onmessage=async e=>{const{id:t,action:r,payload:i}=e.data,o=this.handlers.get(r);let a=null,c=null;if(!o)c=new Error("Handler missing for action "+r);else try{a=await o(i)}catch(u){u instanceof ue?c=u.toJSON():c=u}postMessage({id:t,result:a,error:c})}}var b=(n=>(n.DECRYPT="DECRYPT",n.FIND_QMC_MUSICEX_NAME="FIND_QMC_MUSICEX_NAME",n.KUWO_PARSE_HEADER="KUWO_PARSE_HEADER",n.KUGOU_PARSE_HEADER="KUGOU_PARSE_HEADER",n.QINGTING_FM_GET_DEVICE_KEY="QINGTING_FM_GET_DEVICE_KEY",n.VERSION="VERSION",n))(b||{});let s;const we=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&we.decode();let v=null;function E(){return(v===null||v.byteLength===0)&&(v=new Uint8Array(s.memory.buffer)),v}function h(n,e){return n=n>>>0,we.decode(E().subarray(n,n+e))}let _=0;const K=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},ze=typeof K.encodeInto=="function"?function(n,e){return K.encodeInto(n,e)}:function(n,e){const t=K.encode(n);return e.set(t),{read:n.length,written:t.length}};function g(n,e,t){if(t===void 0){const c=K.encode(n),u=e(c.length,1)>>>0;return E().subarray(u,u+c.length).set(c),_=c.length,u}let r=n.length,i=e(r,1)>>>0;const o=E();let a=0;for(;a<r;a++){const c=n.charCodeAt(a);if(c>127)break;o[i+a]=c}if(a!==r){a!==0&&(n=n.slice(a)),i=t(i,r,r=a+n.length*3,1)>>>0;const c=E().subarray(i+a,i+r),u=ze(n,c);a+=u.written,i=t(i,r,a,1)>>>0}return _=a,i}let p=null;function Y(){return(p===null||p.buffer.detached===!0||p.buffer.detached===void 0&&p.buffer!==s.memory.buffer)&&(p=new DataView(s.memory.buffer)),p}function D(n,e){return n=n>>>0,E().subarray(n/1,n/1+e)}function d(n,e){const t=e(n.length*1,1)>>>0;return E().set(n,t/1),_=n.length,t}function Z(n,e){var t=d(n,s.__wbindgen_malloc),r=_;s.decryptQMC1(t,r,n,e)}function l(n){const e=s.__wbindgen_export_3.get(n);return s.__externref_table_dealloc(n),e}function He(n){var e=d(n,s.__wbindgen_malloc),t=_;const r=s.decryptX2MHeader(e,t,n);if(r[1])throw l(r[0])}function Me(n){var e=d(n,s.__wbindgen_malloc),t=_;const r=s.decryptX3MHeader(e,t,n);if(r[1])throw l(r[0])}function ge(n){const e=d(n,s.__wbindgen_malloc),t=_,r=s.detectAudioType(e,t);if(r[2])throw l(r[1]);return C.__wrap(r[0])}function fe(n,e){if(!(n instanceof e))throw new Error(`expected instance of ${e.name}`)}function pe(n){return n==null}function Ae(){s.initPanicHook()}const ee=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>s.__wbg_audiotyperesult_free(n>>>0,1));class C{static __wrap(e){e=e>>>0;const t=Object.create(C.prototype);return t.__wbg_ptr=e,ee.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,ee.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_audiotyperesult_free(e,0)}get needMore(){return s.__wbg_get_audiotyperesult_needMore(this.__wbg_ptr)>>>0}set needMore(e){s.__wbg_set_audiotyperesult_needMore(this.__wbg_ptr,e)}get audioType(){let e,t;try{const r=s.__wbg_get_audiotyperesult_audioType(this.__wbg_ptr);return e=r[0],t=r[1],h(r[0],r[1])}finally{s.__wbindgen_free(e,t,1)}}set audioType(e){const t=g(e,s.__wbindgen_malloc,s.__wbindgen_realloc),r=_;s.__wbg_set_audiotyperesult_audioType(this.__wbg_ptr,t,r)}}typeof FinalizationRegistry>"u"||new FinalizationRegistry(n=>s.__wbg_jooxfile_free(n>>>0,1));const te=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>s.__wbg_kwmdecipher_free(n>>>0,1));class Re{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,te.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_kwmdecipher_free(e,0)}constructor(e,t){fe(e,F);var r=pe(t)?0:g(t,s.__wbindgen_malloc,s.__wbindgen_realloc),i=_;const o=s.kwmdecipher_make_decipher(e.__wbg_ptr,r,i);if(o[2])throw l(o[1]);return this.__wbg_ptr=o[0]>>>0,te.register(this,this.__wbg_ptr,this),this}decrypt(e,t){var r=d(e,s.__wbindgen_malloc),i=_;s.kwmdecipher_decrypt(this.__wbg_ptr,r,i,e,t)}}typeof FinalizationRegistry>"u"||new FinalizationRegistry(n=>s.__wbg_kwmdecipherv1_free(n>>>0,1));const re=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>s.__wbg_kugou_free(n>>>0,1));class N{static __wrap(e){e=e>>>0;const t=Object.create(N.prototype);return t.__wbg_ptr=e,re.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,re.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_kugou_free(e,0)}static from_header(e){const t=d(e,s.__wbindgen_malloc),r=_,i=s.kugou_from_header(t,r);if(i[2])throw l(i[1]);return N.__wrap(i[0])}static fromHeaderV5(e,t){fe(e,q);var r=pe(t)?0:g(t,s.__wbindgen_malloc,s.__wbindgen_realloc),i=_;const o=s.kugou_fromHeaderV5(e.__wbg_ptr,r,i);if(o[2])throw l(o[1]);return N.__wrap(o[0])}decrypt(e,t){var r=d(e,s.__wbindgen_malloc),i=_;s.kugou_decrypt(this.__wbg_ptr,r,i,e,t)}static decryptDatabase(e){var t=d(e,s.__wbindgen_malloc),r=_;const i=s.kugou_decryptDatabase(t,r,e);if(i[1])throw l(i[0])}}const ne=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>s.__wbg_kugouheader_free(n>>>0,1));class q{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,ne.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_kugouheader_free(e,0)}constructor(e){const t=d(e,s.__wbindgen_malloc),r=_,i=s.kugouheader_new(t,r);if(i[2])throw l(i[1]);return this.__wbg_ptr=i[0]>>>0,ne.register(this,this.__wbg_ptr,this),this}get audioHash(){let e,t;try{const r=s.kugouheader_audioHash(this.__wbg_ptr);return e=r[0],t=r[1],h(r[0],r[1])}finally{s.__wbindgen_free(e,t,1)}}get version(){return s.kugouheader_version(this.__wbg_ptr)>>>0}get offsetToData(){return s.kugouheader_offsetToData(this.__wbg_ptr)>>>0}}const ie=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>s.__wbg_kuwoheader_free(n>>>0,1));class F{static __wrap(e){e=e>>>0;const t=Object.create(F.prototype);return t.__wbg_ptr=e,ie.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,ie.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_kuwoheader_free(e,0)}static parse(e){const t=d(e,s.__wbindgen_malloc),r=_,i=s.kuwoheader_parse(t,r);if(i[2])throw l(i[1]);return F.__wrap(i[0])}get qualityId(){return s.kuwoheader_qualityId(this.__wbg_ptr)>>>0}get resourceId(){return s.kuwoheader_resourceId(this.__wbg_ptr)>>>0}}const se=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>s.__wbg_migu3d_free(n>>>0,1));class z{static __wrap(e){e=e>>>0;const t=Object.create(z.prototype);return t.__wbg_ptr=e,se.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,se.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_migu3d_free(e,0)}static fromHeader(e){const t=d(e,s.__wbindgen_malloc),r=_,i=s.migu3d_fromHeader(t,r);if(i[2])throw l(i[1]);return z.__wrap(i[0])}static fromFileKey(e){const t=g(e,s.__wbindgen_malloc,s.__wbindgen_realloc),r=_,i=s.migu3d_fromFileKey(t,r);if(i[2])throw l(i[1]);return z.__wrap(i[0])}decrypt(e,t){var r=d(e,s.__wbindgen_malloc),i=_;s.migu3d_decrypt(this.__wbg_ptr,r,i,e,t)}}const oe=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>s.__wbg_ncmfile_free(n>>>0,1));class Ue{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,oe.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_ncmfile_free(e,0)}constructor(){const e=s.ncmfile_new();if(e[2])throw l(e[1]);return this.__wbg_ptr=e[0]>>>0,oe.register(this,this.__wbg_ptr,this),this}open(e){const t=d(e,s.__wbindgen_malloc),r=_,i=s.ncmfile_open(this.__wbg_ptr,t,r);if(i[2])throw l(i[1]);return i[0]}decrypt(e,t){var r=d(e,s.__wbindgen_malloc),i=_;const o=s.ncmfile_decrypt(this.__wbg_ptr,r,i,e,t);if(o[1])throw l(o[0])}get audioOffset(){const e=s.ncmfile_audioOffset(this.__wbg_ptr);if(e[2])throw l(e[1]);return e[0]>>>0}}const T=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>s.__wbg_qmc2_free(n>>>0,1));class B{static __wrap(e){e=e>>>0;const t=Object.create(B.prototype);return t.__wbg_ptr=e,T.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,T.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_qmc2_free(e,0)}constructor(e){const t=g(e,s.__wbindgen_malloc,s.__wbindgen_realloc),r=_,i=s.qmc2_new(t,r);if(i[2])throw l(i[1]);return this.__wbg_ptr=i[0]>>>0,T.register(this,this.__wbg_ptr,this),this}decrypt(e,t){var r=d(e,s.__wbindgen_malloc),i=_;s.qmc2_decrypt(this.__wbg_ptr,r,i,e,t)}}const ae=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>s.__wbg_qmcfooter_free(n>>>0,1));class H{static __wrap(e){e=e>>>0;const t=Object.create(H.prototype);return t.__wbg_ptr=e,ae.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,ae.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_qmcfooter_free(e,0)}static parse(e){const t=d(e,s.__wbindgen_malloc),r=_,i=s.qmcfooter_parse(t,r);if(i[2])throw l(i[1]);return i[0]===0?void 0:H.__wrap(i[0])}get ekey(){const e=s.qmcfooter_ekey(this.__wbg_ptr);let t;return e[0]!==0&&(t=h(e[0],e[1]).slice(),s.__wbindgen_free(e[0],e[1]*1,1)),t}get size(){return s.qmcfooter_size(this.__wbg_ptr)>>>0}get mediaName(){const e=s.qmcfooter_mediaName(this.__wbg_ptr);let t;return e[0]!==0&&(t=h(e[0],e[1]).slice(),s.__wbindgen_free(e[0],e[1]*1,1)),t}}const _e=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>s.__wbg_qingtingfm_free(n>>>0,1));class S{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,_e.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_qingtingfm_free(e,0)}static getDeviceKey(e,t,r,i,o,a){const c=g(e,s.__wbindgen_malloc,s.__wbindgen_realloc),u=_,L=g(t,s.__wbindgen_malloc,s.__wbindgen_realloc),R=_,U=g(r,s.__wbindgen_malloc,s.__wbindgen_realloc),O=_,k=g(i,s.__wbindgen_malloc,s.__wbindgen_realloc),be=_,me=g(o,s.__wbindgen_malloc,s.__wbindgen_realloc),ke=_,Ee=g(a,s.__wbindgen_malloc,s.__wbindgen_realloc),Fe=_,x=s.qingtingfm_getDeviceKey(c,u,L,R,U,O,k,be,me,ke,Ee,Fe);var ve=D(x[0],x[1]).slice();return s.__wbindgen_free(x[0],x[1]*1,1),ve}static getFileIV(e){const t=g(e,s.__wbindgen_malloc,s.__wbindgen_realloc),r=_,i=s.qingtingfm_getFileIV(t,r);if(i[3])throw l(i[2]);var o=D(i[0],i[1]).slice();return s.__wbindgen_free(i[0],i[1]*1,1),o}constructor(e,t){const r=d(e,s.__wbindgen_malloc),i=_,o=d(t,s.__wbindgen_malloc),a=_,c=s.qingtingfm_new(r,i,o,a);if(c[2])throw l(c[1]);return this.__wbg_ptr=c[0]>>>0,_e.register(this,this.__wbg_ptr,this),this}decrypt(e,t){var r=d(e,s.__wbindgen_malloc),i=_;s.qingtingfm_decrypt(this.__wbg_ptr,r,i,e,t)}}const ce=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>s.__wbg_xiami_free(n>>>0,1));class I{static __wrap(e){e=e>>>0;const t=Object.create(I.prototype);return t.__wbg_ptr=e,ce.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,ce.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_xiami_free(e,0)}static from_header(e){const t=d(e,s.__wbindgen_malloc),r=_,i=s.xiami_from_header(t,r);if(i[2])throw l(i[1]);return I.__wrap(i[0])}decrypt(e){var t=d(e,s.__wbindgen_malloc),r=_;s.xiami_decrypt(this.__wbg_ptr,t,r,e)}get copyPlainLength(){return s.xiami_copyPlainLength(this.__wbg_ptr)>>>0}}const de=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>s.__wbg_xmlypc_free(n>>>0,1));class le{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,de.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_xmlypc_free(e,0)}static getHeaderSize(e){const t=d(e,s.__wbindgen_malloc),r=_,i=s.xmlypc_getHeaderSize(t,r);if(i[2])throw l(i[1]);return i[0]>>>0}constructor(e){const t=d(e,s.__wbindgen_malloc),r=_,i=s.xmlypc_new(t,r);if(i[2])throw l(i[1]);return this.__wbg_ptr=i[0]>>>0,de.register(this,this.__wbg_ptr,this),this}get audioHeader(){const e=s.xmlypc_audioHeader(this.__wbg_ptr);var t=D(e[0],e[1]).slice();return s.__wbindgen_free(e[0],e[1]*1,1),t}get encryptedHeaderOffset(){return s.xmlypc_encryptedHeaderOffset(this.__wbg_ptr)>>>0}get encryptedHeaderSize(){return s.xmlypc_encryptedHeaderSize(this.__wbg_ptr)>>>0}decrypt(e){var t=d(e,s.__wbindgen_malloc),r=_;const i=s.xmlypc_decrypt(this.__wbg_ptr,t,r,e);if(i[2])throw l(i[1]);return i[0]>>>0}}async function xe(n,e){if(typeof Response=="function"&&n instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(n,e)}catch(r){if(n.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const t=await n.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{const t=await WebAssembly.instantiate(n,e);return t instanceof WebAssembly.Instance?{instance:t,module:n}:t}}function Ke(){const n={};return n.wbg={},n.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,t){let r,i;try{r=e,i=t,console.error(h(e,t))}finally{s.__wbindgen_free(r,i,1)}},n.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},n.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,t){const r=t.stack,i=g(r,s.__wbindgen_malloc,s.__wbindgen_realloc),o=_;Y().setInt32(e+4*1,o,!0),Y().setInt32(e+4*0,i,!0)},n.wbg.__wbindgen_copy_to_typed_array=function(e,t,r){new Uint8Array(r.buffer,r.byteOffset,r.byteLength).set(D(e,t))},n.wbg.__wbindgen_error_new=function(e,t){return new Error(h(e,t))},n.wbg.__wbindgen_init_externref_table=function(){const e=s.__wbindgen_export_3,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)},n.wbg.__wbindgen_throw=function(e,t){throw new Error(h(e,t))},n}function De(n,e){return s=n.exports,ye.__wbindgen_wasm_module=e,p=null,v=null,s.__wbindgen_start(),s}async function ye(n){if(s!==void 0)return s;typeof n<"u"&&(Object.getPrototypeOf(n)===Object.prototype?{module_or_path:n}=n:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof n>"u"&&(n=new URL("/assets/um_wasm_bg-BhXEaAwz.wasm",import.meta.url));const e=Ke();(typeof n=="string"||typeof Request=="function"&&n instanceof Request||typeof URL=="function"&&n instanceof URL)&&(n=fetch(n));const{instance:t,module:r}=await xe(await n,e);return De(t,r)}function Ie(){{const n=new URL("/assets/um_wasm_bg-BhXEaAwz.wasm",import.meta.url),e=n.protocol==="file:"?import("node:fs/promises").then(t=>t.readFile(n)).catch(t=>{console.log("read wasm failed",t)}):void 0;return ye({module_or_path:e}).then(()=>(Ae(),!0))}}function Le(){return"0.1.10"}const Oe=Ie();async function Te(n,e){return e()}async function Se(n,e){return e()}const Ce=n=>n instanceof Blob?n:new Blob([n]);function*f(n,e=4096){const t=n.byteLength;for(let r=0;r<t;r+=e){const i=Math.min(r+e,t);yield[n.subarray(r,i),r]}}class P{cipherName="NCM/PC";tryInit(e,t){let r=1024;for(;r!==0;)if(console.debug("NCM/open: read %d bytes",r),r=e.open(t.subarray(0,r)),r===-1)throw new y("file is not ncm")}async decrypt(e){const t=new Ue;try{this.tryInit(t,e);const r=e.slice(t.audioOffset);for(const[i,o]of f(r))t.decrypt(i,o);return{status:w.OK,cipherName:this.cipherName,data:r}}finally{t.free()}}static make(){return new P}}class j{cipherName="none";async decrypt(e){return{cipherName:"None",status:w.OK,data:e,message:"No decipher applied"}}static make(){return new j}}function qe(n){let e=256,t="bin";for(;e!==0;){console.debug("AudioDetect: read %d bytes",e);const r=ge(n.subarray(0,e));t=r.audioType,e=r.needMore,r.free()}return t}function he(n){if(n.byteLength<32)return!1;const e=ge(n.subarray(0,32)),t=e.needMore!==0||e.audioType!=="bin";return e.free(),t}class W{cipherName="QQMusic/QMC1";async decrypt(e){const t=e.slice(0,32);if(Z(t,0),!he(t))throw new y("does not look like QMC file");const r=new Uint8Array(e);for(const[i,o]of f(r))Z(i,o);return{status:w.OK,cipherName:this.cipherName,data:r}}static create(){return new W}}class M{constructor(e){this.useUserKey=e,this.cipherName=`QQMusic/QMC2(user_key=${+e})`}cipherName;parseFooter(e){const t=H.parse(e.subarray(e.byteLength-1024));if(t){const{size:r,ekey:i}=t;return t.free(),{size:r,ekey:i}}if(!this.useUserKey)throw new y("Not QMC2 File");return{size:0}}async decrypt(e,t){const r=this.parseFooter(e.subarray(e.byteLength-1024)),i=this.useUserKey?t.qmc2Key:r.ekey;if(!i)throw new Error("EKey required");const o=new B(i),a=e.slice(0,e.byteLength-r.size);for(const[c,u]of f(a))o.decrypt(c,u);return o.free(),{status:w.OK,cipherName:this.cipherName,data:a}}static createWithUserKey(){return new M(!0)}static createWithEmbeddedEKey(){return new M(!1)}}class X{cipherName="Kuwo";async decrypt(e,t){let r,i;try{r=F.parse(e.subarray(0,1024)),i=new Re(r,t.kwm2key);const o=new Uint8Array(e.subarray(1024));for(const[a,c]of f(o))i.decrypt(a,c);return{status:w.OK,cipherName:this.cipherName,data:o}}finally{i?.free(),r?.free()}}static make(){return new X}}class Q{cipherName="Kugou";async decrypt(e,t){let r,i;try{i=new q(e.subarray(0,1024)),r=N.fromHeaderV5(i,t.kugouKey);const o=new Uint8Array(e.subarray(1024));for(const[a,c]of f(o))r.decrypt(a,c);return{status:w.OK,cipherName:this.cipherName,data:o}}finally{i?.free(),r?.free()}}static make(){return new Q}}class A{constructor(e,t){this.decipher=e,this.cipherType=t,this.cipherName=`Ximalaya (Android, ${t})`}cipherName;async decrypt(e,t){const r=e.slice(0,1024);if(this.decipher(r),!he(r))throw new y(`Not a Xmly android file (${this.cipherType})`);const i=new Uint8Array(e);return i.set(r,0),{cipherName:this.cipherName,status:w.OK,data:i}}static makeX2M(){return new A(He,"X2M")}static makeX3M(){return new A(Me,"X3M")}}class V{cipherName="Ximalaya (PC)";async decrypt(e,t){const r=le.getHeaderSize(e.subarray(0,1024)),i=new le(e.subarray(0,r)),{audioHeader:o,encryptedHeaderOffset:a,encryptedHeaderSize:c}=i,u=a+c,L=e.byteLength-u,R=e.slice(a,u),U=i.decrypt(R),O=o.byteLength+U+L;i.free();const k=new Uint8Array(O);return k.set(o),k.set(R,o.byteLength),k.set(e.subarray(u),o.byteLength+U),{status:w.OK,data:k,cipherName:this.cipherName}}static make(){return new V}}class G{cipherName="Xiami (XM)";async decrypt(e){const t=I.from_header(e.subarray(0,16)),{copyPlainLength:r}=t,i=e.slice(16);for(const[o]of f(i.subarray(r)))t.decrypt(o);return t.free(),{cipherName:this.cipherName,status:w.OK,data:i}}static make(){return new G}}function Be(n){return Array.from(n,e=>e.toString(16).padStart(2,"0")).join("")}function Pe(n){const e=[];for(const[t]of n.matchAll(/[0-9a-fA-F]{2}/g))e.push(parseInt(t,16));return new Uint8Array(e)}class ${cipherName="QingTingFM (Android, qta)";async decrypt(e,t){const r=Pe(t.qingTingAndroidKey||""),i=S.getFileIV(t.fileName);if(r.byteLength!==16||i.byteLength!==16)return{status:w.FAILED,message:"device key or iv invalid"};const o=new S(r,i),a=new Uint8Array(e);for(const[c,u]of f(a))o.decrypt(c,u);return{cipherName:this.cipherName,status:w.OK,data:a}}static make(){return new $}}class J{cipherName="Migu3D (Keyless)";async decrypt(e){const t=z.fromHeader(e.subarray(0,256)),r=new Uint8Array(e);for(const[i,o]of f(r))t.decrypt(i,o);return t.free(),{cipherName:this.cipherName,status:w.OK,data:r}}static make(){return new J}}var w=(n=>(n[n.OK=0]="OK",n[n.NOT_THIS_CIPHER=1]="NOT_THIS_CIPHER",n[n.FAILED=2]="FAILED",n))(w||{});const je=[P.make,Q.make,X.make,V.make,G.make,$.make,M.createWithUserKey,M.createWithEmbeddedEKey,J.make,W.create,A.makeX2M,A.makeX3M,j.make];async function We(n){try{return[await n,null]}catch(e){return[null,e]}}class Xe{constructor(e,t,r){this.buffer=t,this.options=r,this.label=`DecryptCommandHandler(${e})`}label;log(e,t){return Te(`${this.label}: ${e}`,t)}async decrypt(e){const t=[];for(const r of e){const i=r(),[o,a]=await We(this.tryDecryptWith(i));if(!a){if(o)return o;t.push(`${i.cipherName}: no response`);continue}const c=a.message;c&&t.push(`${i.cipherName}: ${c}`),a instanceof y?console.debug("[%s] Not this decipher:",i.cipherName,a):console.error("decrypt failed with unknown error: ",a)}throw new y(t.join(`
`))}async tryDecryptWith(e){const t=await this.log(`try decrypt with ${e.cipherName}`,async()=>e.decrypt(this.buffer,this.options));switch(t.status){case w.NOT_THIS_CIPHER:return null;case w.FAILED:throw new Error(`failed: ${t.message}`)}let r=t.overrideExtension||qe(t.data);if(!t.overrideExtension&&r==="bin")throw new y("unable to produce valid audio file");return r.toLowerCase()==="mp4"&&(r="m4a"),{decrypted:URL.createObjectURL(Ce(t.data)),ext:r}}}const Qe=async({id:n,blobURI:e,options:t})=>{await Oe;const r=n.replace("://",":"),i=`decrypt(${r})`;return Se(i,async()=>{const o=await fetch(e).then(c=>c.arrayBuffer());return new Xe(r,new Uint8Array(o),t).decrypt(je)})},Ve=async({blobURI:n})=>{const t=await(await fetch(n,{headers:{Range:"bytes=-1024"}}).then(r=>r.blob())).arrayBuffer();try{const r=new Uint8Array(t.slice(-1024));return H.parse(r)?.mediaName||null}catch{return null}};async function Ge({device:n,brand:e,model:t,product:r,manufacturer:i,board:o}){const a=S.getDeviceKey(n,e,t,r,i,o);return Be(a)}const $e=async({blobURI:n})=>{const t=await(await fetch(n,{headers:{Range:"bytes=0-1023"}}).then(r=>r.blob())).arrayBuffer();try{const r=new Uint8Array(t.slice(0,1024)),i=F.parse(r),{qualityId:o,resourceId:a}=i;return i.free(),{qualityId:o,resourceId:a}}catch{return null}},Je=async({blobURI:n})=>{const t=await(await fetch(n,{headers:{Range:"bytes=0-1023"}}).then(o=>o.blob())).arrayBuffer(),r=new Uint8Array(t.slice(0,1024));let i;try{i=new q(r);const{version:o,audioHash:a}=i;return{version:o,audioHash:a}}catch{return null}finally{i?.free()}},m=new Ne;onmessage=m.onmessage;m.addEventHandler(b.DECRYPT,Qe);m.addEventHandler(b.FIND_QMC_MUSICEX_NAME,Ve);m.addEventHandler(b.VERSION,Le);m.addEventHandler(b.KUWO_PARSE_HEADER,$e);m.addEventHandler(b.KUGOU_PARSE_HEADER,Je);m.addEventHandler(b.QINGTING_FM_GET_DEVICE_KEY,Ge);
